package com.zywl.app.defaultx.cache;

import com.zywl.app.base.bean.User;
import com.zywl.app.base.bean.UserDzPeriods;
import com.zywl.app.base.constant.RedisKeyConstant;
import com.zywl.app.defaultx.cache.impl.RedisService;
import com.zywl.app.defaultx.service.DzPeriodsService;
import com.zywl.app.defaultx.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

@Service
public class DzCacheService extends RedisService {

    @Autowired
    private DzPeriodsService dzPeriodsService;

    @Autowired
    private UserService userService;

    @Autowired
    private UserCacheService userCacheService;

    //缓存数据，上一期的期数详情，有效期为24小时，因为这数据不会变，所以留存即可，定时的时候 会清理这部分数据
    public UserDzPeriods getDzInitInfo(){
            //查数据库，将上一期的数据放入其中
            UserDzPeriods userDzPeriods = dzPeriodsService.findOne();
            if(null!= userDzPeriods){
                //同时，根据幸运儿userId 查出其名称，头像信息
                User user = userCacheService.getUserInfoById(userDzPeriods.getUserId());
                if(null!=user){
                    userDzPeriods.setUserName(user.getName());
                    userDzPeriods.setUserImage(user.getHeadImageUrl());
                }
            }else {
                //第一期
                userDzPeriods = new UserDzPeriods();
                userDzPeriods.setPeriods(0);
                userDzPeriods.setUserImage("");
                userDzPeriods.setUserId(0L);
                userDzPeriods.setUserName("");
                userDzPeriods.setCuMoney(BigDecimal.ZERO);
                userDzPeriods.setUserDkNum(0);
                userDzPeriods.setUserDZNum(0);
            }

        return userDzPeriods;
    }
    //玩家是否待领取
    public Boolean getUserLqInfo(String userId){
        String key = RedisKeyConstant.APP_USER_DZ_LQ_USERID_NOW;
        List<String> userIdsRedis = getList(key,String.class);
        if(null == userIdsRedis){
            return false;
        }
        return userIdsRedis.contains(userId);
    }
    //查看玩家是否打卡
    public Boolean getUserDkInfo(long userId){
        String key = RedisKeyConstant.APP_USER_DZ_DK_USERID;
        List<String> lists = getList(key,String.class);
        if(null == lists){
            return false;
        }
        return lists.contains(String.valueOf(userId));
//        String userIdsRedis = get(key);
//        if(StringUtils.isEmpty(userIdsRedis)){
//            return false;
//        }
//        return userIdsRedis.contains(userId+"");
    }
    //玩家是否报名
    public Boolean getUserBmInfo(long userId){
        String key = RedisKeyConstant.APP_USER_DZ_BM_USERID_NOW;
        List<String> userIdsRedis = getList(key,String.class);
        if(null == userIdsRedis){
            return false;
        }
        return userIdsRedis.contains(userId+"");
    }
    public List<String> getUserImageUrl(){
        List<String> userIds = getList(RedisKeyConstant.APP_USER_DZ_BM_USERID_NOW,String.class);
        List<String> imageUrls = new ArrayList<>();
        if(null == userIds){
            return imageUrls;
        }
        //展示最新的10个人的头像 ，所以不用缓存了，直接找出来返回去
            if(userIds.size()>10){
                for(int i = userIds.size();i>(userIds.size()-10);i--){
                    User user = userCacheService.getUserInfoById(Long.parseLong(userIds.get(i-1)));
                    if(null != user){
                        imageUrls.add(user.getHeadImageUrl());
                    }
                }
            }else {
                for(String userImage : userIds) {
                    User user = userCacheService.getUserInfoById(Long.parseLong(userImage));
                    if(null!=user){
                        imageUrls.add(user.getHeadImageUrl());
                    }
                }
            }
        return imageUrls;
    }
    //取
    public String getUsersMoney(){
        String key =  RedisKeyConstant.APP_USER_DZ_MONEY;
        return get(key);
    }

    public String getUsersNum(){
        String key = RedisKeyConstant.APP_USER_DZ_PERIODS_NUM;
        return get(key);
    }


    //打卡过的userId ,丢入数据库，有效期为24小时 ，这个跑批的时候，会定时清理redis的数据
    public Boolean setUserIdDkIntoCache(long userId){
        String key = RedisKeyConstant.APP_USER_DZ_DK_USERID;
        List<String> lists  = getList(key,String.class);
        if(null == lists){
            lists = new ArrayList<>();
        }
        lists.add(String.valueOf(userId));
        return set(RedisKeyConstant.APP_USER_DZ_DK_USERID,lists);
    }

    //报名过的userId ,丢入数据库
    public Boolean setUserIdBmIntoCache(String userId){
        String key = RedisKeyConstant.APP_USER_DZ_BM_USERID_NOW;
        List<String> userIdsRedis = getList(key,String.class);
        int num = 0;
        String usersNum = get(RedisKeyConstant.APP_USER_DZ_PERIODS_NUM);
        if(null == userIdsRedis){
            userIdsRedis =new ArrayList<>();
        }else if(userIdsRedis.contains(userId)){
            return true;
        }
        userIdsRedis.add(userId);
        if(StringUtils.isEmpty(usersNum)){
            num = 1;
        }else {
            num = Integer.parseInt(usersNum) +1;
        }
        set(RedisKeyConstant.APP_USER_DZ_BM_USERID_NOW,userIdsRedis);
        stringSet(RedisKeyConstant.APP_USER_DZ_PERIODS_NUM,num);
        return true;
    }

    //待领取玩家集合
    public Boolean setUserIdLqIntoCache(List<String> nowSet){
        String key = RedisKeyConstant.APP_USER_DZ_LQ_USERID_NOW;
        List<String>  userIdRedis =  getList(key,String.class);
        if(null == userIdRedis){
            userIdRedis = nowSet;
        }else {
            userIdRedis.addAll(nowSet);
        }

        return set(RedisKeyConstant.APP_USER_DZ_LQ_USERID_NOW,userIdRedis);
    }
    //当期打坐用户灵石总数量
    public boolean setUsersMoney(BigDecimal money){
        String key =  RedisKeyConstant.APP_USER_DZ_MONEY;
        String monyes = get(key);
        if(StringUtils.isEmpty(monyes)){
            return stringSet(RedisKeyConstant.APP_USER_DZ_MONEY,money);
        }
        return stringSet(RedisKeyConstant.APP_USER_DZ_MONEY,new BigDecimal(monyes).add(money));
    }

    //清楚打坐上期游戏
    public void removeDzInfo(){
        String key = RedisKeyConstant.APP_USER_DZ_BEAN + "DzCacheBean";
        del(key);
        del(RedisKeyConstant.APP_USER_DZ_DK_USERID);
        del(RedisKeyConstant.APP_USER_DZ_BM_USERID_NOW);
        del(RedisKeyConstant.APP_USER_DZ_MONEY);
        del(RedisKeyConstant.APP_USER_DZ_PERIODS_NUM);
        for (int i = 0; i < 10; i++) {
            del(RedisKeyConstant.APP_USER_DZ_BM_IMAGE+i);
        }
    }
    //清除已经领取过的userID
    public void removeLqUserId(String userId){
        String key = RedisKeyConstant.APP_USER_DZ_LQ_USERID_NOW;
        List<String> userIds = getList(key,String.class);
        if(null!=userIds){
            //这里校验
            userIds.remove(userId);
            set(RedisKeyConstant.APP_USER_DZ_LQ_USERID_NOW,userIds);
        }

    }

    public static void main(String[] args) {
        String str = "9829,21603,24006,7874,7315,9034,8931,10889,12756,14161,14161,116553,13831,9172,9250,9362,418386,14432,52829,57237,15854,7255,7391,7436,8020,8388,8539,8909,9376,9450,9506,9819,9881,9896,8130,8185,8267,8505,8539,9376,8305,8449,8481,8789,8909,9334,8505,8511,8733,8978,7490,8359,8889,9682,9910,7963,8524,7252,7255,7338,7545,7615,7652,7673,7429,7436,7850,7919,7810,7810,8524,9471,9928,8185,8264,8267,8267,8322,8325,8426,8546,8690,8742,7668,8789,8794,8921,8921,9247,8928,9877,9029,9029,9036,9283,9299,9450,9471,9486,9562,9682,9781,9816,9862,9910,10441,10441,10474,10555,7317,10764,10821,10876,10889,10909,10943,9933,11092,12745,11619,11650,11654,11666,11752,7778,11777,8246,9199,9301,21109,21345,12143,21663,22333,12244,22481,22638,12268,12295,23060,12320,12321,24866,12509,26492,27371,12745,12752,12752,12756,12763,7810,8151,8717,12897,12926,29269,9362,9532,12953,9632,9795,29795,9816,30019,30179,13079,13106,13252,13370,13486,13624,13802,38043,8909,8931,39613,9660,9933,14177,14325,14433,14479,14668,8455,14868,14958,51871,15720,15724,7276,15750,7647,15764,58707,9174,9486,61007,16310,16495,16544,16544,16716,7806,16845,16845,9682,9999,17124,17155,17225,17234,7270,7289,7289,7322,17363,7429,7429,7647,17713,17718,17779,7874,8746,8126,18144,8173,8267,8305,8322,8325,8414,8426,8449,8490,18583,18691,8176,8490,18895,8909,8921,9214,8995,9120,19141,9179,9179,9301,9471,9514,9718,9721,7266,7490,9793,8246,9910,20513,9199,9247,20924,20987,20987,11305,11754,11787,13194,21332,21332,21397,21538,16316,21631,16404,21661,21681,7874,8359,20629,22124,28941,30019,30688,23553,8717,9542,9876,24006,24006,24268,24390,44483,24465,24515,45615,24592,24730,7397,7668,9471,53994,8455,25846,8699,9471,26137,68223,9120,9467,27155,7391,75701,7668,8005,7963,9771,8073,8109,8174,28308,8359,8492,8595,8615,8746,28748,8794,89236,28941,9034,29112,9486,29810,98107,29811,8615,29861,30377,30723,8490,9447,12167,31474,16174,31724,17291,17433,9334,9342,32162,8504,33569,7270,33879,35514,35573,7490,8236,58749,9928,36435,36555,36592,7836,9881,37038,70743,7270,7389,74424,7806,37806,7838,7838,8388,7874,37988,8125,38205,8359,8492,93029,9862,40533,7668,41317,42715,42715,28283,42893,9214,9352,37363,43027,44302,44579,8569,7350,7631,8388,48388,88378,9361,9009,9542,96450,9682,9999,14023,17577,8449,51871,23060,9606,9793,33816,53601,37644,48860,9362,9896,56799,7286,7338,8569,58962,9933,7273,10642,11777,8490,62196,23715,24515,35601,39382,45393,9319,7807,8388,8733,8742,8789,66151,72608,7281,7460,7746,9881,8174,8176,8385,8414,85434,8569,7836,8173,9028,9299,9342,9609,69643,9721,69736,8073,9928,8699,9600,71434,7460,20560,7252,25910,7270,7281,7281,8303,28308,72884,7315,7315,7319,7319,7322,7322,7338,7338,7350,7359,36156,8742,9447,9609,9660,7397,7436,74366,7471,7471,7471,7471,7545,8710,8956,9250,76065,7607,63488,7647,7673,7673,7707,7707,70787,7350,7356,75701,77595,7874,7968,9862,8087,8130,8178,8275,8477,8710,87148,7903,9144,9247,7963,9660,7273,97839,9795,9069,8125,80813,8087,9362,81062,10737,8125,12504,8130,81647,8173,8174,17433,8178,8978,9447,26024,8267,8303,32197,34397,9028,9036,44483,8449,8449,8455,8511,8524,8524,8539,8544,8546,8267,85826,8595,8615,63761,8654,66513,8236,8723,8717,8746,76306,8794,8185,84278,8490,8492,85075,8595,8615,8746,8789,8789,88378,90002,8928,8931,9819,89851,8654,8995,8995,9034,9047,8511,90856,9632,10173,9114,14651,15119,16687,7440,9174,9174,9179,8982,20021,9214,9214,22388,22459,9247,9247,9247,7315,9282,9283,9299,9299,9301,93118,9319,9329,9334,9334,9334,9342,9342,9352,9352,9361,9362,9376,7765,37765,9174,9400,9447,9450,45316,9456,9467,9471,48555,9563,9506,9514,53601,9542,9562,9562,7270,7350,7777,57777,9563,9600,9609,96556,9658,9660,9673,9781,9819,9718,9721,7255,7338,9748,9771,9771,97711,97776,7778,7807,7807,9781,8176,9781,7841,9795,9795,8082,8127,9816,9817,8178,9817,9819,9819,8236,8246,8275,9829,8359,98412,8573,9862,9863,9874,9876,9881,9376,99376,9632,10024,10040,10040,10068,8544,9009,10111,101020,15585,16218,8546,22481,24805,7266,35904,36032,7350,10418,10433,10433,10441,10441,10472,10610,10631,10643,10643,10666,10682,10686,68605,7276,10727,10727,7286,7356,10737,7460,7539,107594,10763,10764,7319,7807,7903,9034,10821,8595,8746,10879,8014,8176,10887,8909,9175,8921,9214,9028,10905,109052,10909,9250,9361,10943,10943,97742,10981,9817,10981,8573,10986,10986,9881,10988,10988,11036,11043,10642,10843,8544,10981,11098,10418,111606,11650,11170,11170,7356,18216,118361,11837,11973,120561,12506,12564,112680,8696,11305,113406,34142,13559,11358,13580,11358,11366,11366,7668,137668,11378,11378,8126,8385,8490,8601,113946,13952,13952,13980,13980,39806,14082,14479,48555,9342,11510,11510,11510,15119,15281,11535,11535,15378,15418,11543,15432,11543,15473,15473,11551,115729,15750,7545,7850,15825,11583,15907,9172,15936,115948,9658,11605,11605,11605,11619,11650,11653,11654,11666,166733,11668,11668,11668,11671,11671,167741,11683,11683,11692,9934,170006,70705,17173,171799,7286,7286,117427,17433,11752,7647,17689,17716,7255,7810,9542,80010,8109,118109,18144,11816,11816,8174,8229,11837,18525,18635,8723,11880,9877,19154,9329,9334,9362,19362,19380,94342,19541,9600,96108,96729,8414,9863,20017,20063,12016,12034,12052,12052,12052,12052,20555,12060,20629,20806,8544,8995,20957,12119,12119,12084,12143,12143,14432,14595,216408,12167,21680,8524,21908,9262,12222,12252,12252,25664,22585,12268,12268,12268,22778,122804,122804,12295,12295,230001,23024,123075,12320,12340,12340,234097,236106,7471,12375,24345,12437,12456,7389,9874,12509,12509,250951,12509,12546,12561,12562,12562,12600,26168,26504,12651,65621,265862,7281,12678,7850,12678,12678,12705,7286,12745,12745,275434,12756,12763,76657,12774,12776,12776,12779,7850,9175,7919,9282,12797,12803,12803,12803,8151,128233,128233,8275,28323,8385,12847,12847,12847,85285,8539,28793,28793,8794,8178,289612,12897,12897,9009,29009,29104,9120,9183,9199,9199,29208,92085,9214,12926,12926,9352,9376,9400,29430,9471,29480,12953,12953,9542,29559,9660,12974,9771,8125,8505,9874,8789,8909,9514,12997,130061,130779,8352,30835,30835,8794,13091,309130,9376,9718,9934,31059,13106,13107,31152,131158,312109,14463,14898,31633,13168,31724,7647,8524,13207,24006,13241,13241,13248,13248,25046,132579,13275,327723,8246,13303,13303,35219,13370,13370,7494,39613,34397,44316,134473,134792,8325,8327,35111,35387,35550,35612,135644,7273,13580,13580,13580,58650,8710,13588,9718,13607,36132,13624,13649,13649,367900,8327,136944,13708,13708,37103,37283,7429,13760,13760,7615,7670,137674,13769,13769,8889,7903,9034,7919,37966,13802,8073,8151,8305,38662,8699,7874,138806,8921,9816,39330,93301,9467,9514,13952,39526,9542,9660,9910,9933,9999,402252,40469,10905,15936,14161,14167,17326,7545,14202,42367,7338,29121,29208,14309,14325,43250,32973,14336,33941,143394,436197,7270,8477,9881,44113,44113,44674,14463,14464,7266,44726,14479,7963,14479,8544,8690,9028,51239,45391,14550,45724,145920,46198,62384,8109,8151,8359,47008,14720,7389,7460,7490,7494,147494,7494,147494,7607,14762,14762,14762,47705,47752,8087,7850,14785,7850,14785,14785,14785,8723,9047,147914,147914,148145,82027,48290,148355,148355,8385,8388,48388,8505,8573,14868,14880,8931,9352,14898,8982,14898,14900,90002,14900,149116,9144,49216,149254,149272,9361,9429,9506,9532,9532,9562,14958,96196,9793,149802,9816,8505,9910,15052,15053,507098,10887,19528,25046,52552,8174,15281,8690,8699,53214,8359,15418,15418,15418,15418,15432,43203,15432,15433,15447,15447,15447,46883,15473,8449,155014,15503,15503,15526,15526,15542,15542,15542,15585,8654,9514,9632,9781,56575,156640,7841,56799,70196,71967,15720,15720,572259,15724,73217,57571,7668,7807,78019,7874,7968,8126,15825,8504,15854,15854,8546,15854,15860,8647,58731,7670,7777,8794,8109,9342,15895,8956,15895,9660,9795,9009,15907,15907,15907,15907,15907,9179,9247,9262,59325,9342,15947,15947,94799,159517,9562,9594,9600,15969,9790,15980,16013,16013,160226,16058,16058,8229,9400,10737,61283,14032,15181,16289,18187,9771,21038,21153,21599,16218,16223,16223,8246,628755,9748,9214,9721,16404,64247,16444,16444,64624,46925,16484,9282,9721,16503,16519,16574,16574,16574,16578,16578,16578,8173,8246,8746,9009,16598,16614,66192,66275,66397,166733,16676,16676,16678,7874,16678,16687,16687,7397,67437,7647,9172,9262,9342,16794,8082,68082,16809,168158,68239,8385,16845,8505,8511,16856,68603,687026,16874,16879,88114,9069,8982,69118,16942,69478,9532,16953,96684,8303,9467,99832,70370,8569,17106,17106,17106,17128,171297,15516,17155,17157,17157,18033,8125,8303,17234,17234,17263,17263,7266,7266,7273,7281,7286,172871,8717,172871,7289,17291,29430,7317,7319,17341,17341,17341,7356,17370,7389,7389,7389,7389,7397,39827,7422,7440,7441,46494,17467,17467,7494,75099,175388,7545,7553,7553,8185,7607,7631,7673,7545,7322,7359,17764,76657,17782,17788,7919,8020,17821,78623,9606,79606,18018,8020,8151,9120,8127,81313,8174,8176,17628,18203";
//;
////        List<String> lists = Collections.singletonList(s);
//
//        List<String> list1 = Arrays.asList(str.split(","));
//        System.out.println(list1.size());


        String aaa = "14683,13698,7460,555672,8921,7553,7794,9351,7807,214780,9690,9793,7231,15180,7406,9289,9429,7553,7629,7802,9145,9351,9276,9658,67040,11795,7794,9288,8302,7319,15958,9069,9069,9607,572981,69736,7910,7490,9532,7545,12853,9910,9069,8699,15848,7695,14597,11551,7910,7338,7910,8357,7532,9899,8504,8912,8352,8200,9606,9470,9144,7806,7910,8302,10079,47171,8173,9532,39473,10375,7324,69736,37648,16434,9910,9089,9470,9243,7480,8490,9899,9793,9276,9588,14651,7807,61398,9069,8414,9716,7910,8912,16272,8330,9606,9276,9910,8005,11421,8352,43883,8357,15874,8912,9716,7884,9328,8504,15378,83692,8479,15907,7695,9289,7877,11605,20307,7581,8758,36851,8612,63127,8537,7771,9326,9243,9328,9173,9069,8388,11997,12027,7910,9351,8693,7532,7254,12378,9218,7422,8693,7940,47385,11972,9658,9089,10084,24454,9351,9470,68468,8352,56246,7545,15958,9716,10324";

        List<String> list2 = Arrays.asList(str.split(","));
        System.out.println(list2.size());
        List<String> list3 = new ArrayList<>();
        for(String userId : list2){
            if(list3.isEmpty()){
                list3.add(userId);
            }else {
                if(!list3.contains(userId)){
                    list3.add(userId);
                }
            }
        }
        System.out.println(list3.size());
        StringBuilder bbb = new StringBuilder();
        for(String user : list3){
            bbb.append(user).append(",");
        }
        System.out.println(bbb);
    }

}
