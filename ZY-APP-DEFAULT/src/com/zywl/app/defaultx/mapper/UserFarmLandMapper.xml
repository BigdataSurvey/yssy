<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zywl.app.defaultx.mapper.UserFarmLandMapper">

    <!-- 通用字段映射 -->
    <resultMap id="BaseResultMap" type="com.zywl.app.base.bean.UserFarmLand">
        <id     column="id"          property="id"/>
        <result column="user_id"     property="userId"/>
        <result column="land_index"  property="landIndex"/>
        <result column="seed_item_id" property="seedItemId"/>
        <result column="start_time"  property="startTime"/>
        <result column="end_time"    property="endTime"/>
        <result column="status"      property="status"/>
        <result column="last_harvest_time"      property="lastHarvestTime"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 通用列 -->
    <sql id="Base_Column_List">
        id,
        user_id,
        land_index,
        seed_item_id,
        start_time,
        end_time,
        status,
        last_harvest_time,
        create_time,
        update_time
    </sql>

    <!-- 按 userId 查询用户全部土地信息 -->
    <select id="findListByUserId" parameterType="map" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_user_farm_land
        WHERE user_id = #{userId}
        ORDER BY land_index ASC
    </select>


    <!-- 主键查询 -->
    <select id="selectByPrimaryKey" parameterType="long" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from t_user_farm_land
        where id = #{id}
    </select>

    <!--查询用户指定位置的一块地 -->
    <select id="findOneByUserAndIndex" parameterType="map" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_user_farm_land
        WHERE user_id = #{userId} AND land_index = #{landIndex}
    </select>


    <insert id="plantLand" parameterType="com.zywl.app.base.bean.UserFarmLand">
        INSERT INTO t_user_farm_land
        (user_id, land_index, seed_item_id, start_time, end_time, status, last_harvest_time, create_time, update_time)
        VALUES
            (#{userId}, #{landIndex}, #{seedItemId}, #{startTime}, #{endTime}, #{status}, #{lastHarvestTime}, NOW(), NOW())
            ON DUPLICATE KEY UPDATE
                                 seed_item_id       = VALUES(seed_item_id),
                                 start_time         = VALUES(start_time),
                                 end_time           = VALUES(end_time),
                                 status             = VALUES(status),
                                 last_harvest_time  = VALUES(last_harvest_time),
                                 update_time        = NOW()
    </insert>

    <!-- 统计总数-->
    <select id="countByConditions" parameterType="map" resultType="int">
        select count(1)
        from t_user_farm_land
        <where>
            <if test="id != null">
                and id = #{id}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="landIndex != null">
                and land_index = #{landIndex}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="minStartTime != null">
                and start_time &gt;= #{minStartTime}
            </if>
            <if test="maxStartTime != null">
                and start_time &lt;= #{maxStartTime}
            </if>
        </where>
    </select>


    <!-- 按 userId 清空农场种植状态，保留地块 -->
    <update id="clearAllByUserId" parameterType="long">
        UPDATE t_user_farm_land
        SET
            seed_item_id      = NULL,
            start_time        = NULL,
            end_time          = NULL,
            last_harvest_time = NULL,
            status            = 0,
            update_time       = NOW()
        WHERE user_id = #{userId}
    </update>


</mapper>
